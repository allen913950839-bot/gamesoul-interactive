# 紧急修复：首页闪退 + 数据库丢失

## 问题描述
1. ✅ 首页访问闪退
2. ❌ 数据库内容不见了

## 问题分析

### 问题1：API查询参数错误
**错误代码**：
```javascript
// App.jsx 中使用了错误的参数名
fetch('/api/get-public-conversations?limit=6&offset=0&sortBy=popular')
```

**API实际接受的参数**：
```javascript
// get-public-conversations.js
const { limit = 20, offset = 0, sort = 'recent' } = req.query;
```

**参数名不匹配**：`sortBy` ≠ `sort`

### 问题2：Vercel KV数据库未配置或数据丢失
可能原因：
1. Vercel项目没有连接KV数据库
2. 环境变量 `KV_REST_API_URL` 和 `KV_REST_API_TOKEN` 未配置
3. KV数据库实例被删除或重置

## 修复方案

### ✅ 已修复：API参数错误
**修改文件**：`src/App.jsx`

```javascript
// 修复前
fetch('/api/get-public-conversations?limit=6&offset=0&sortBy=popular')

// 修复后
fetch('/api/get-public-conversations?limit=6&offset=0&sort=popular')
```

### 🔧 待处理：Vercel KV配置

#### 步骤1：检查数据库连接
访问诊断接口查看状态：
```
https://你的域名/api/check-db
```

或本地测试：
```bash
npm run dev
# 访问 http://localhost:5173/api/check-db
```

#### 步骤2：配置Vercel KV（如果未配置）

1. **登录Vercel Dashboard**
   - 访问 https://vercel.com/dashboard
   - 进入项目 `GameSoul-Interactive`

2. **添加KV数据库**
   - 点击 `Storage` 标签
   - 点击 `Create Database`
   - 选择 `KV (Key-Value)`
   - 创建数据库（选择免费套餐）

3. **连接数据库到项目**
   - 创建完成后，点击 `Connect to Project`
   - 选择 `GameSoul-Interactive` 项目
   - 确认连接

4. **验证环境变量**
   - 进入 `Settings` → `Environment Variables`
   - 确认存在以下变量：
     - `KV_REST_API_URL`
     - `KV_REST_API_TOKEN`
     - `KV_REST_API_READ_ONLY_TOKEN`

5. **重新部署**
   - 环境变量更新后，需要重新部署项目
   - 在 `Deployments` 页面点击最新部署的 `...` 菜单
   - 选择 `Redeploy`

## 数据恢复说明

### 如果数据库被清空
Vercel KV是持久化存储，数据不应该丢失。如果确实丢失，可能原因：
1. **数据库实例被删除** - 需要重新创建
2. **环境变量指向错误的实例** - 检查URL和Token
3. **从未保存过数据** - 之前可能使用的是本地mock数据

### 测试保存功能
完成配置后，测试一次对话保存：
1. 进入聊天界面
2. 聊几轮对话
3. 点击"保存"按钮，选择"公开到广场"
4. 访问广场查看是否显示
5. 刷新首页查看精选区域是否加载

## 技术细节

### 诊断接口功能
新增 `api/check-db.js` 提供以下检查：
- ✅ 环境变量配置状态
- ✅ 数据库连接测试
- ✅ 读写功能验证
- ✅ 公开对话数量统计

### 首页精选广场的容错机制
```javascript
// 已有完善的错误处理
try {
  const response = await fetch('/api/get-public-conversations?...');
  if (response.ok) {
    const data = await response.json();
    setFeaturedConversations(data.conversations || []);
  } else {
    setFeaturedConversations([]); // 失败时显示空状态
  }
} catch (err) {
  setFeaturedConversations([]); // 异常时显示空状态
}

// UI层也有检查
{featuredConversations && featuredConversations.length > 0 ? (
  // 显示对话卡片
) : (
  // 显示空状态提示
)}
```

## 验证清单

### 本地验证
- [ ] 运行 `npm run dev`
- [ ] 访问 `http://localhost:5173/api/check-db`
- [ ] 检查返回的诊断信息
- [ ] 首页不再闪退

### 生产环境验证
- [ ] 访问 `https://你的域名/api/check-db`
- [ ] 确认KV配置正常
- [ ] 测试保存对话功能
- [ ] 首页精选区域正常显示
- [ ] 广场功能正常

## 下次部署命令

```bash
# 提交修复
git add .
git commit -m "fix: 修复API参数错误和添加数据库诊断接口"
git push origin main
```

## 总结

**立即修复**：
- ✅ 修复了API查询参数错误（sortBy → sort）
- ✅ 添加了数据库诊断接口

**需要您操作**：
1. 访问诊断接口检查数据库状态
2. 如果KV未配置，按照步骤2配置
3. 配置完成后重新部署

修复完成后首页将不再闪退，并且可以正常保存和展示对话数据。
